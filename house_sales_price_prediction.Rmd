---
title: "King County House Price Prediction using Regression Methods"
author: "Yashar Mansouri"
date: "4/16/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
```

```{r}
library(mltools)
library(MASS)
library(car)
library(psych)
library(tidyverse)
library(lubridate)
```

# Data Info

This dataset contains house sale prices for King County, which includes Seattle. It includes homes sold between May 2014 and May 2015.

Dataset can be found at [kaggle](https://www.kaggle.com/harlfoxem/housesalesprediction/) and contains 21k+ records.

**id**: Unique ID for each home sold

**date**: Date of the home sale

**price**: Price of each home sold \<-- target variable

**bedrooms**: Number of bedrooms

**bathrooms**: Number of bathrooms, where .5 accounts for a room with a toilet but no shower

**sqft_living**: Square footage of the apartments interior living space

**sqft_lot**: Square footage of the land space

**floors**: Number of floors

**waterfront**: - A dummy variable for whether the apartment was overlooking the waterfront or not

**view**: An index from 0 to 4 of how good the view of the property was

**condition**: - An index from 1 to 5 on the condition of the apartment,

**grade**: An index from 1 to 13, where 1-3 falls short of building construction and design, 7 has an average level of construction and design, and 11-13 have a high quality level of construction and design.

**sqft_above**: The square footage of the interior housing space that is above ground level

**sqft_basement**: The square footage of the interior housing space that is below ground level

**yr_built**: The year the house was initially built

**yr_renovated**: The year of the house's last renovation

**zipcode**: What zipcode area the house is in

**lat**: Lattitude

**long**: Longitude

**sqft_living15**: The square footage of interior housing living space for the nearest 15 neighbors

**sqft_lot15**: The square footage of the land lots of the nearest 15 neighbors

# Data Import
```{r}
df = read_csv("data/kc_house_data.csv")
glimpse(df)
```

```{r}
summary(df)
```

```{r}
df[duplicated(df),] #no duplicates
```

## Initial findings and decisions based on data

Columns to be dropped:

``` {.r}
['id',
'lat',
'long']
```

What if we fit the model without analyzing the data?

```{r}
reg = lm(price ~ bedrooms + bathrooms + sqft_living + 
           sqft_lot + floors + waterfront + view + condition + 
           grade + view + condition + grade + sqft_above + 
           sqft_basement + yr_built + yr_renovated + sqft_living15 + 
           sqft_lot15, data=df)

summary(reg)
```




```{r fig.height = 10, fig.width = 15, fig.align = "center"}
plot(reg)
```



Quantitative:

``` {.r}
['price',
'bedrooms',
'bathrooms',
'sqft_living',
'sqft_lot',
'floors',
'view',
'condition',
'grade',
'sqft_above',
'sqft_basement',
'yr_built',
'yr_renovated',
'sqft_living15',
'sqft_lot15']
```

Categorical:

``` {.r}
['waterfront', 
'zipcode']
```

```{r}
df %>% 
  select(-c(id, lat, long)) -> df
```

```{r}
df %>% 
  mutate(waterfront = as_factor(waterfront),
         zipcode = as_factor(zipcode)) -> 
  df
```

# EDA & Feature Engineering

## Categoricals

```{r}
df$waterfront %>% 
  table()
```

Out of 21613 records, only 163 has `waterfront`.

```{r}
df %>% 
  ggplot(aes(x=waterfront, y=price)) +
  geom_boxplot() +
  theme_bw()
```


```{r}
df %>% 
  group_by(zipcode) %>% 
  summarise(count = n()) %>% 
  arrange(-count) %>% 
  glimpse()
```

Highest occuring zip code is **98103** and least occuring is **98039** . There are 70 unique zip codes in total.

Categorical analysis shows that most houses has no `waterfront` and the `zipcode` 98103 is the most occuring one in the dataframe.


```{r fig.height = 15, fig.width = 15, fig.align = "center"}
df %>% 
  ggplot(aes(x=fct_reorder(as_factor(zipcode), price), y=price)) +
  geom_boxplot() + 
  theme_bw() + 
  labs(x='zipcode') +
  theme(axis.text.x = element_text(angle = 90))
```
zipcode can be a variable that can contribute to better prediction and there are 70 unique zip codes.
The graph above shows that some areas have significantly different price distributions. Since the numerical value of zipcode cannot be used, it's better to create dummy variables. 

## Quantitative


```{r fig.height = 15, fig.width = 15, fig.align = "center"}

df %>% slice_sample(n=500) %>% # sampling for 500 values, r is too slow
  select(-c('waterfront', 'zipcode')) %>% 
  pairs.panels(method = "pearson", # correlation method
               hist.col = "#CA64EA",
               density = TRUE,  # show density plots
               ellipses = FALSE # show correlation ellipses
               )
```

```{r fig.height = 5, fig.width = 8, fig.align = "center"}
df %>% 
  ggplot(aes(x=fct_reorder(as_factor(view), price), y=price)) +
  geom_boxplot() + 
  labs(x='view') +
  theme_bw()
```

```{r fig.height = 5, fig.width = 8, fig.align = "center"}
df %>% 
  ggplot(aes(x=fct_reorder(as_factor(grade), price), y=price)) +
  geom_boxplot() + 
  labs(x='grade') +
  theme_bw()
```

It seems it would be ok to use `waterfront`, `view`, and `grade` as is.

```{r}
df
```

# Feature Engineering

## Year Values

```{r}
# getting sales year and month and age 
df %>% 
  mutate(yr_sales = year(date), 
         month_sales = month(date),
         age = yr_sales - yr_built) ->
  df

df[,c("yr_sales", "month_sales", "age")] %>% glimpse()
```

```{r}
# getting age_renovated before sales if there has been renovation
df %>% 
  mutate(age_renovated = 0,
         age_renovated = if_else(yr_renovated != 0, 
                                 yr_sales - yr_renovated, 
                                 age)) -> df

df[,c("age", "age_renovated")] %>% glimpse()
```




```{r}
breaks = c(-2,1,5,10,20,30,50,100000)
labels = c(0,5,10,20,30,60,100)

df$age_bin = cut(df$age, breaks = breaks, labels = labels)

df %>% 
  ggplot(aes(x=age_bin)) + 
  geom_bar() + theme_bw()

```
```{r}
breaks = c(-2,1,5,10,20,30,50,100000)
labels = c(0,5,10,20,30,60,100)

df$age_renovated_bin = cut(df$age_renovated, breaks = breaks, labels = labels)

df %>% 
  ggplot(aes(x=age_renovated_bin)) + 
  geom_bar() + theme_bw()
```
```{r}
# converting the age_bin and age_renovated_bin to numericals
df$age_bin <- as.integer(df$age_bin)
df$age_renovated_bin <- as.integer(df$age_renovated_bin)
df$waterfront <- as.integer(df$waterfront)
```



```{r}
# dropping date, yr_built, yr_renovated, 

df %>% 
  select(-c(date, yr_built, yr_renovated, age, age_renovated)) -> 
  df
```


```{r}
# without zip code
reg = lm(price ~ bedrooms + bathrooms + sqft_living + sqft_lot + floors + waterfront + view + condition + grade + sqft_above + sqft_basement + sqft_living15 + sqft_lot15 + yr_sales + month_sales + age_bin + age_renovated_bin, data=df)

summary(reg)
```
## Feature Normalization
```{r fig.height = 10, fig.width = 12, fig.align = "center"}
df %>%
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_histogram() +
  geom_density(aes(y = ..count..), alpha = .2, fill = "#FF6666") +
  theme_bw()
```

```{r fig.height = 10, fig.width = 12, fig.align = "center"}
df %>%
  select(price, sqft_above, sqft_living, sqft_lot, sqft_basement, sqft_living15, sqft_lot15) %>% 
  gather() %>% 
  ggplot(aes(log(value))) +
  facet_wrap(~ key, scales = "free") +
  geom_histogram() +
  geom_density(aes(y = ..count..), alpha = .2, fill = "#FF6666") +
  theme_bw()
```
These values will be better with logarithm transformation. Since `sqft_basement` is the only value with 0, I add +1 to avoid Inf values.

```{r}
df["price_log"] = log(df["price"])
df["sqft_above_log"] = log(df["sqft_above"])
df["sqft_basement_log"] = log(df["sqft_basement"]+1)
df["sqft_living_log"] = log(df["sqft_living"])
df["sqft_living15_log"] = log(df["sqft_living15"])
df["sqft_lot_log"] = log(df["sqft_lot"])
df["sqft_lot15_log"] = log(df["sqft_lot15"])
```


## One Hot Encoding `zipcode`
- will drop the initial `zipcode = 98001`

```{r}
zipcode_dummies <- as.data.frame(dummy.code(df$zipcode))
zipcode_dummies <- zipcode_dummies[, order(names(zipcode_dummies))]
zipcode_dummies$`98001` <- NULL
```
```{r}
df %>% glimpse()

df %>% select(-c(price, sqft_living, sqft_lot, sqft_above, sqft_basement,
                 zipcode, sqft_living15, sqft_lot15, yr_sales, month_sales)) ->
  df
```

```{r}
round(cor(df),2)
```
```{r}
# without zipcode
reg = lm(price_log ~ bedrooms + bathrooms + floors + waterfront + view + condition + 
         grade + age_bin + age_renovated_bin + sqft_above_log + sqft_basement_log + 
         sqft_living_log + sqft_living15_log + sqft_lot_log + sqft_lot15_log,
         data = df)
summary(reg)

plot(reg)
```
```{r}
# attaching zipcode

```


















































































































































